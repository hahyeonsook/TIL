
## NAT

* Private Network: IPv4 중 특정 대역을 공인 인터넷이 아닌 가정, 기업 등의 한정된 공간에 사용한 네트워크를 의미함. 사설망에 소속된 IP인 사설 IP 대역은 오로지 사설망(내부망)에서만 사용 가능하기 때문에 공인망(외부망)에선 사용할 수 없음.
* IP 주소 혹은 IP 패킷의 TCP/UDP Port 숫자를 변환 및 재기록하여 네트워크 트래픽을 주고받는 기술을 의미함. 사설망에서 공인망으로, 공인망에서 사설망으로 통신하고자 할 때, 공인망/사설망에서 사용하는 IP로 변환하는 것을 의미한다고 볼 수 있음.
* NAT은 IP 주소뿐만 아니라 Port까지 변환시켜 사용함. 이를 Port Address Translation(PAT)라고 부름.
  * 사설망에서 공인망에 존재하는 서버에 접속하고자 할 때, 사용자 1은 자신이 가지고 있는 사설망 IP를 공인 IP로 반드시 변환해야 함. 이를 NAT Device가 수행함.
  * 그리고 공인망에 존재하는 서버에게 응답 패킷이 들어오면, NAT 장비가 과거 사용자가 보낸 요청에 대한 응답임을 기억(Stateful)하고, 목적지 IP를 공인 IP에서 사용자1이 가진 사설 IP로 변환하여 전달함.
  * 그런데, 패킷을 받으려면 Port 번호가 필요함. 빈번한 경우는 아니지만 다른 사설 IP를 가진 사용자들에게서 Port 번호가 중복될 수도 있음. 되돌아 올때, 어떤 사용자에게 줘야할지 혼란이 옴.
  * 그때문에 사용하는 것이 PAT임 사용자들에게 요청을 받아 NAT를 할 때, 출발지 port를 임의로 변경함. 그래서 공인 IP가 하나이지만 사용자마다 포트로 구분할 수 있도록 함.
* NAT는 출발지 IP 변경 뿐만 아니라 목적지 IP를 변환할 수도 있음. 이의 대표적인 예가 L4 스위치임.

### Session Table & Stateful

* NAT를 수행하는 네트워크 장비의 종류는 매우 다양함. 주로 관문 역할(Gateway)을 하는 네트워크 장비가 주로 NAT를 수행함. 가정에서는 공유기가, 기업에서는 과거 라우터가 자주 이 역할을 맡았으나 요즘에는 방화벽, VPN, L4 스위치 등이 이 역할을 좀 더 많이 수행함.
* 공인망에 노출되는만큼 보안기능을 곁들인 장비로 함. NAT 장비는 자신에게 설정된 규칙에 따라 허용/거부를 판단하고 NAT를 실시하고 이를 기록해둠. 이를 수행하는 장비들을 보통 Session 장비라고 하고, NAT를 실시한 내역을 기록한 테이블을 Session Table이라고 부름.
* 보통 세션 장비에 정해진 Rule에 의해 허용된 IP만이 NAT를 실시할 수 있고, 세션 테이블에 이름을 올릴 수 있음. 주로 방화벽과 같은 장비가 이러한 역할을 수행함. 그리고 테이블에 기록된 IP는 규칙에 의해 나가거나 들어온 뒤 다시 들어오거나 나갈 수 있음. 즉 규칙에 의해 한 번 허용이 된 패킷(Request)은 반대 방향(Response)에 대한 정책을 별도로 수립할 필요 없이 테이블에 기록된 세션을 보고 네트워크 장비가 통과시킨다는 것을 의미함. 이러한 특성을 Stateful이라 함.

### NAT의 종류

* Static NAT: IP와 IP를 일대일 방식으로 변환
* Dynamic NAT: IP Pool과 IP 1개 혹은 IP Pool을 다대다 방식으로 변환
* NAPT: 포트까지 같이 변환
* Source IP NAT: Source IP를 변환
* Destination IP NAT(DNAT): Destination IP 변환

## Subnet

#### Subnetting

* 네트워크 관리자가 네트워크 성능을 향상시키기 위해, 자원을 효율적으로 분배하는 것. 자원을 효율적으로 분배한다는 것은 네트워크 영역과 호스트 영역을 분할하는 것.
* 너무 큰 브로드캐스트 도메인은 네트워크 환경에서 패킷전송을 느리게 하고 성능저하를 발생시킴. 따라서 네트워크를 쪼개서 통신 성능을 보장하는 것임.
  * 브로드캐스트 도메인: 라우터와 네트워크장비 없이 통신할 수 있는 영역

#### Subnet Mask

* 한 네트워크에서 1~100까지 IP를 할당받을 수 있고, 우리가 필요한 IP가 20개 정도라고 가정할 때, 굳이 1~100까지 IP를 줄 필요가 없음. 최소 1~20까지만 IP를 주면 됨. 그럼 나머지 21~100은 사용자가 신경쓰지 않도록 서브넷마스크로 가려버림.
* IP는 32자리 2진수로 표현할 수 있음. 서브넷마크스 또한 IP 크기만큼 32자리 2진수로 표현함.
* 서브넷마스크는 1과 0으로 이뤄져있고, 1이 연속으로 나와야 함.
* IP 주소에서 만약 192.168.0.1/24라고 하면 이는 C 클래스이고 기본 디폴트 마스크는 255.255.255.0 임.
  * 255.255.255.0 == 1111 1111.1111 1111.1111 1111.0000 0000
  * 192.168.0.1/24에서 24는 1이 24개가 있다는 뜻임. 1은 네트워크 영역으로 사용하겠다는 뜻이고, 0은 호스트 IP로 사용하겠다는 뜻임. 즉 사용자에게 0이 표현된 부분만 호스트 IP를 할당할 수 있게 만들겠다는 뜻임.

#### 기본 서브넷마스크, 서브넷네트워크

* 210.100.100.1이라는 IP 주소가 있을때, 기본 서브넷마스크와 서브넷네트워크는?
  * 192.0.0~233.255.255는 C 클래스로 210.100.100까지가 Network 주소이고, 1부분이 호스트로 사용될 수 있는 호스트 주소임.
    * 네트워크 주소는 공통될 수 있는 주소이고, 호스트는 유일한 식별자임.
  * 별개의 서브넷마스크를 생성하지 않아도 기본적으로 적용되어 있는게 기본 서브넷마스크이고, 기본 서브넷마스크로 쪼개진 네트워크 주소를 서브넷 네트워크라고 함.
  * 따라서 C 클래스인 210.100.100.1의 기본 서브넷마스크(클래스를 나누는 서브넷마스크)는 255.255.255.0, 서브넷 네트워크는 210.100.100.0 임.
* 150.150.100.1에서 C클래스의 기본 서브넷마스크인 255.255.255.0을 사용하면?
  * B 클래스인 150.150.100.1의 서브넷마스크는 255.255.255.0, 서브넷 네트워크는 150.150.100.0이 됨.
  * 이것은 B 클래스 주소를 마치 C 클래스 주소처럼 사용하겠다는 뜻임.
  * B 클래스는 150.150까지가 Network 주소이고 100.0이 Host 주소인데, 255.255.255.0인 서브넷마스크를 씌우면서 150.150.100까지 Network 주소로 사용하고, 1만 Host 주소로 사용하도록 만든 것임.
  * 즉, 네트워크 영역을 늘이고, 호스트 영역을 줄이겠다는 뜻을 내포하는 것임.
  * 이렇게, 하나의 주소에 서브넷마스크를 씌워서 자신에게 맞는 네트워크를 만드는 것을 서브네팅이라고 함.
  * 서브넷마스크로 나뉘어진 서브넷네트워크간 통신은 라우터를 통해서 통신되어야 함. 내부의 사설망이라는 뜻.
* 네트워크 영역, 호스트 영역 범위는?
  * 201.222.5.0의 주소에 255.255.255.248의 사용자가 만든 서브넷마스크를 씌우면?
  * 11001001 11011110 00000101 00000000 == 201.255.5.0(IP 주소)
  * 11111111 11111111 11111111 11111000 == 255.255.255.248(서브넷마스크)
    * 11111111 11111111 11111111 기본 C 클래스가 가질 수 있는 네트워크 영역
    * 11111 사용자가 지정한 네트워크 영역
      * 서브넷네트워크가 가질 수 있는 네트워크 영역 
      * 2^5 = 32개
    * 000 사용자가 지정한 호스트 영역
      * 각 서브넷마스크가 가질 수 있는 호스트 영역
      * 2^3 = 8개, 하지만 네트워크 주소와 브로드캐스트 주소를 써야하기 때문에 -2를 해줘서 6개.
* 서브넷마스크는 IP를 네트워크 영역과 호스트 영역으로 나눠주는 것임. 기본서브넷네트워크도 네트워크 영역과 호스트 영역을 나눠주기 때문에 서브넷마스크라고도 함. 하지만 진정한 의미의 서브넷마스크는 A클래스, B클래스, C클래스의 기본 서브넷마스크에서 가질 수 있는 네트워크 영역과 호스트 영역을 더 쪼개서 더 효율적으로 서브네팅하는 것임.


## L4 Load Balancing vs L7 Load Balancing

### L4 Load Balancing

* Layer 4(TCP와 UDP)에서 IP와 Port를 활용하여 서버부하분산을 하는 것을 의미함.
* 로드밸런싱의 기준점이 IP와 Port이기 때문에 TCP/UDP의 Header를 분석하여 로드밸런싱에 활용하지는 않음. 그래서 프로토콜 헤더를 통해 로드밸런싱을 하기보다 해당 프로토콜들의 특성으로 인한 행동을 제어하는 편임.
  * 예를 들어 3-way handshake를 제어하거나 커넥션을 언제 끊을 것인지, 커넥션을 얼마나 유지할 것인지, Connection Time out에 도달하면 어떻게 할 것인지 등을 제어함.

### L7 Load Balancing

* L4를 넘어 Layer 7의 프로토콜 헤더를 분석하여 로드밸런싱을 실시하는 것을 의미함. IP와 Port를 사용하여 로드밸런싱을 하는 것은 같으나 Layer 7 프로토콜을 통해 사용자 정의 로드밸런싱을 실시하거나 Layer 7 프로토콜 헤더를 조작/활용할 수 있다는 특징이 있음. 
* L7 Virtual Server 설정시 Layer 4의 프로토콜을 정의해야 함.
  * L4 프로토콜과 L7 프로토콜은 별개로 움직이는 것이 아님. 어떤 프로토콜들은 TCP를 기반으로 움직이며, 어떤 프로토콜들은 UDP를 기반으로 움직임.
    * HTTP는 TCP 기반의 프로토콜임. 그렇기 때문에 HTTP 톨신을 하기 위해서는 반드시 3-way-handshake를 실시하여 신뢰성 있는 연결을 생성해야 함. 그 다음에 HTTP GET을 통해 리소스를 얻어오거나 POST를 통해 업데이트를 실시하는 것임.
    * DNS는 TCP/UDP를 모두 활용하는 Layer 7 프로토콜임. 기본적으로 DNS는 UDP를 사용하지만 전달해야하는 패킷의 크기가 달라지면 UDP를 사용할 수 없음. UDP는 패킷의 크기가 512bit를 초과할 수 없기 때문에 DNS를 로드밸런싱 중 패킷의 크기가 512를 넘으면 TCP를 사용해야 함. 그렇기 때문에 DNS를 제대로 로드밸런싱하기 위해서는 TCP 기반의 L7 Virtual Server와 UDP 기반의 l7 Virtual Server 모두 생성해야 함.
    * 


---
* [NAT 쉽게 이해하기](https://aws-hyoh.tistory.com/145)
* [소규모 네트워크 스위칭 환경 구축](https://josaboo.tistory.com/16?category=904396)
* [서브넷마스크란?](https://limkydev.tistory.com/166)