## 병목

### Load Average 확인
* `top`, `uptime` 등의 명령으로 Load Average를 확인함.
* Load Average는 시스템 전체의 부하상황을 나타내는 지표지만, 병목의 원인이 어딘지를 판단할 수 없음.

### CPU, I/O 중 병목 원인 조사
* Load Average가 높을 경우, CPU와 I/O 어느 쪽에 원인이 있는지를 조사함.
* `sar`, `vmstat`로 시간 경과에 따라 CPU 사용률이나 I/O 대기율의 추이를 확인하여 규명함.

### CPU 부하가 높은 경우
* `top`, `sar`로 사용자 프로그램의 처리가 병목인지, 시스템 프로그램이 원인인지를 확인함.
* `ps`로 볼 수 있는 프로세스의 상태나 CPU 사용시간 등을 보면서 원인이 되고 있는 프로세스를 찾음.
* 프로세스를 찾은 후 보다 상세하게 조사할 경우, `strace`로 추적하거나 `oprofile`로 프로파일링을 해서 병목지점을 좁혀감.

#### 일반적으로 CPU 부하가 걸리고 잇는 것은 다음 상황 중 하나
* 디스크나 메모리 용량 등 그 밖의 부분에서는 병목이 되지 않는, 말하자면 이상적인 상태
* 프로그램이 폭주해서 CPU에 필요이상의 부하가 걸리는 경우

### I/O 부하가 높은 경우
* I/O 부하가 높은 경우, 프로그램으로부터 입출력이 많아서 부하가 높거나, 스왑이 발생해서 디스크 액세스가 발생하고 있는 상황 중 하나
* `sar`, `vmstat`로 스왑의 발생상황을 확인해서 문제를 가려냄.
* 스왑이 발생하고 있을 경우, 다음과 같은 점을 실마리로 조사함.
  * 특정 프로세스가 극단적으로 메모리를 소비하고 있지 않은지를 `ps`로 확인함.
  * 프로그램 오류로 메모리를 지나치게 사용하고 있는 경우에는 프로그램을 개선함.
  * 탑재된 메모리가 부족한 경우에는 메모리를 증설함. 메모리를 증설할 수 없으면 분산을 검토함.
* 스왑이 발생하고 있지 않을 경우, 캐시에 필요한 메모리가 부족한 경우를 생각해볼 수 있음. 
* 해당 서버가 저장하고 있는 데이터 용량과 증설 가능한 메모리량을 비교해서 다음과 같이 나눠서 검토함.
  * 메모리 증설로 캐시영역을 확대시킬 수 있는 경우는 메모리를 증설함.
  * 메모리 증설로 대응할 수 없는 경우는 데이터 분산이나 캐시서버 도입 등을 검토함.
  * 프로그램을 개선해서 I/O 빈도를 줄이는 것도 검토함.

## 부하란 무엇인가

### 부하의 두 종류
* CPU 부하
* I/O 부하

## Load Average가 보고하는 부하의 정체
* HW는 일정 주기로 CPU로 중단 신호를 보냄(타이머 인터럽트).
* 이 중단마다 시간을 진행시키거나 실행 중인 프로세스가 cpu를 얼마나 사용했는지를 계산하는 등 시간에 관련된 처리를 수행함.
* 이 때, 타이머 인터럽트마다 Load Average 값이 계산됨.
* 커널은 타이머 인터럽트가 발생했을 때 실행가능 상태인 task와 I/O 대기인 태스크의 개수를 세어둔 후, 그 값을 단위시간으로 나눈 것이 Load Average 값임.

* Load Average가 의미하는 부하는, **처리를 실행하려고 해도 실행할 수 없어서 대기하고 있는 프로세스의 수**
  * CPU의 실행권한이 부여되기를 기다리고 있는 프로세스
  * 디스크 I/O가 완료하기를 기다리고 있는 프로세스